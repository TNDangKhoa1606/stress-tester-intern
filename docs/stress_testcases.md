# Bảng Thiết Kế Test Case Hiệu Năng

Tài liệu này chi tiết hóa các kịch bản kiểm thử hiệu năng sẽ được thực thi.

---

**Pre-condition:** Hệ thống demo API đã được khởi chạy qua Docker và có thể truy cập tại `http://localhost:8000`. Tất cả các kịch bản đều đã tích hợp validation cho response.

---

| ID | Description | Number of virtual users | Running time | Step | Expected | Actual | Notes |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **TC_BASE_00** | **Baseline Test (Sanity Check):** Thiết lập hiệu năng cơ sở. | 10 VU | 5 phút | 1. Chạy tải ổn định với 10 VU trong 5 phút. | Tất cả các endpoint đều đáp ứng ngưỡng SLO (p95/p99, error rate). | **KHÔNG ĐẠT**<br>- Ghi nhận nhiều lỗi `401 Unauthorized` ở `GET /auth/users/me`.<br>- **Phân tích:** Lỗi kiến trúc, token đăng nhập không được chia sẻ giữa các worker của server. | - Mix: 80% /products, 20% Auth<br>- Pacing: 0.5-2.0s<br>- Công cụ: Locust |
| **TC_RAMP_01** | **Ramp-up Test (Khởi động):** "Làm nóng" hệ thống và kiểm tra hiệu năng ở tải cơ bản. | 0 → 60 VU | 10 phút | 1. Chạy Locust với ramp-up từ 0 đến 60 VU trong 5 phút.<br>2. Giữ tải ổn định trong 5 phút.<br>3. Giám sát biểu đồ thời gian thực. | - Luồng `/products`: p95 ≤ 800ms, error < 0.5%.<br>- Luồng `Auth`: p95 ≤ 1000ms, error < 1%. | **KHÔNG ĐẠT**<br>- RPS: 39.4<br>- p50: 440ms (Đạt)<br>- p95 (Auth): **1200ms** (Vượt SLO ≤1000ms)<br>- p99: **1300ms** (Vượt SLO ≤1200ms)<br>- Error (Checkout): **2.07%** (Vượt SLO <1%) | - Mix: 80% /products, 20% Auth<br>- Pacing: 0.5-2.0s<br>- Công cụ: Locust |
| **TC_STEP_VU_02** | **Step-Stress Test (by VU):** Tìm điểm gãy (breakpoint) bằng cách tăng số người dùng ảo (VU) theo từng bậc. | 5 bậc: 10 → 30 → 60 → 100 → 150 VU | 15 phút (tổng cộng) | 1. Sử dụng `stress_shape.py` để chạy 5 bậc tải:<br>- Bậc 1: 10 VU trong 1 phút.<br>- Bậc 2: 30 VU trong 2 phút.<br>- Bậc 3: 60 VU trong 3 phút.<br>- Bậc 4: 100 VU trong 4 phút.<br>- Bậc 5: 150 VU trong 5 phút. | Xác định được **Breakpoint**: bậc tải đầu tiên mà `p95` > SLO trong 3 phút liên tiếp hoặc `error rate` > SLO trong 1 phút liên tiếp. | **ĐÃ THỰC HIỆN**<br>**Breakpoint được xác định ở 100 VU.**<br>Bảng kết quả:<br>• **10 VU:** RPS 10.0, p95 290ms, Lỗi 0.2% (Đạt)<br>• **30 VU:** RPS 31.2, p95 300ms, Lỗi 0.0% (Đạt)<br>• **60 VU:** RPS 48.1, p95 720ms, Lỗi 0.2% (Đạt)<br>• **100 VU:** RPS 50.4, p95 **1400ms** (Vượt SLO)<br>• **150 VU:** RPS 51.9, p95 **2700ms** (Vượt SLO) | - Mix: 80% /products, 20% Auth<br>- Pacing: 0.5-2.0s<br>- Công cụ: Locust |
| **TC_STEP_VU_03** | **Step-Stress Test (v2 - Concurrency-based):** Tìm điểm gãy theo mô hình tải của Locust, dựa trên việc tăng số người dùng đồng thời (VU). | 5 bậc: 25 → 50 → 75 → 90 → 110 VU | 25 phút (5 phút/bậc) | 1. Chạy Locust với `LoadTestShape` từ file `locust/shapes/step_stress_v2.py`.<br>2. Mỗi bậc chạy trong 5 phút (3 phút ổn định, 2 phút đo lường).<br>3. Theo dõi RPS thực tế, p95 và tỷ lệ lỗi ở 2 phút cuối mỗi bậc. | - Xác định được **Breakpoint**: bậc tải đầu tiên mà `p95 > 800ms` hoặc `error rate > 1%` trong 2 phút đo lường.<br>- Hoặc RPS bão hòa (không tăng đáng kể khi VU tăng). | **ĐÃ THỰC HIỆN**<br>**Breakpoint được xác định ở 90 VU.**<br>Bảng kết quả:<br>• **25 VU:** Đạt (p95 < 800ms)<br>• **50 VU:** Đạt (p95 < 800ms)<br>• **75 VU:** Đạt (p95 ~750ms)<br>• **90 VU:** **KHÔNG ĐẠT** (p95 > 800ms)<br>• **110 VU:** **KHÔNG ĐẠT** (p95 tiếp tục tăng) | - Mix: 80% /products, 20% Auth<br>- Pacing: 0.5-2.0s<br>- Công cụ: Locust<br>- **Ghi chú:** Kịch bản này được thiết kế lại theo khuyến nghị để phù hợp với mô hình tải của Locust (closed model). |
| **TC_CONST_VU_04** | **Constant Load Test (by VU):** Kiểm tra khả năng duy trì một mức tải ổn định, gần với điểm gãy đã xác định. | ~80 VU | 15 phút | 1. Chạy Locust với số lượng VU ổn định (ví dụ: 80 VU) trong 15 phút.<br>2. Theo dõi p95 và tỷ lệ lỗi. | - Hệ thống duy trì được RPS ổn định (ví dụ: ~40-45 RPS).<br>- `p95 response time` và `error rate` không vượt ngưỡng SLO. | **ĐẠT**<br>- Hệ thống duy trì tải ổn định ở 80 VU.<br>- RPS trung bình: ~52 RPS.<br>- p95 response time: ~780ms (dưới 800ms).<br>- Tỷ lệ lỗi: ~0.1% (dưới 1%). | - Mix: 80% /products, 20% Auth<br>- Pacing: 0.5-2.0s<br>- Công cụ: Locust<br>- **Ghi chú:** Kịch bản này không cần `LoadTestShape` tùy chỉnh. Chạy trực tiếp bằng tham số CLI:<br>`--users 80 --run-time 15m` |
| **TC_SPIKE_05** | **Spike Test (Kiểm tra phục hồi):** Đánh giá khả năng chịu sốc tải và phục hồi của hệ thống. | Spike: 0 → 200 VU (30s) | ~7.5 phút | 1. Tăng đột ngột lên 200 VU trong 30s.<br>2. Giữ tải trong 2 phút.<br>3. Giảm về 20 VU và theo dõi 5 phút. | Đo được **Recovery Time**. **Pass** nếu p95 < 800ms và error rate < 1% trong ≤ 120s sau khi giảm tải. | **ĐẠT**<br>- Hệ thống chịu được spike 200 VU.<br>- **Thời gian phục hồi (Recovery Time): 10 giây**.<br>- Trong vòng ~10s sau khi giảm tải, p95 đã quay trở lại dưới 800ms và lỗi < 1%. | - Mix: 100% Auth Flow<br>- Pacing: 0.2-1.0s<br>- Công cụ: Locust |
| **TC_SOAK_06** | **Soak Test (Kiểm tra độ bền):** Tìm rò rỉ bộ nhớ/tài nguyên khi chạy tải ổn định trong thời gian dài. | Tải tương đương ~80% breakpoint đo được (ví dụ 80 VU) | 60 phút | 1. Chạy headless với tải không đổi trong 60 phút.<br>2. Theo dõi biểu đồ p95, error rate, CPU, memory của server theo thời gian. | - **Pass:** p95, error rate, CPU, memory duy trì ổn định.<br>- **Fail:** Có hiện tượng suy giảm hiệu năng (latency drift), hoặc error rate/memory/CPU tăng dần. | **KHÔNG ĐẠT**<br>- Có hiện tượng suy giảm hiệu năng (**latency drift**).<br>- Biểu đồ p95 cho thấy xu hướng tăng dần trong suốt thời gian chạy.<br>- Từ khoảng phút thứ 30 trở đi, p95 bắt đầu vượt ngưỡng 800ms. | - Mix: 80% /products, 20% Auth<br>- Pacing: 0.5-2.0s<br>- Công cụ: Locust |

**Ghi chú chung:**
- **An toàn:** Các bài test sẽ tự động dừng nếu tỷ lệ lỗi vượt quá 5% trong 120 giây liên tục.
- **Tham chiếu:** Tất cả các ngưỡng SLO và định nghĩa chi tiết được tham chiếu từ file `docs/test_plan.md`.
